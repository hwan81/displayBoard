<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="frame-src 'self' https: data:; object-src 'none'; base-uri 'self';">
    <title>ë””ì§€í„¸ ê²Œì‹œíŒ</title>
    <!-- <script src="https://cdn.tailwindcss.com"></script> -->
     <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        html, body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            width: 100%;
            height: 100%;
            background-color: #ffffff; /* Changed to white */
            color: #1a202c; /* Changed to dark for general text */
            font-family: 'Pretendard', sans-serif;
        }
        .display-grid {
            display: grid;
            grid-template-rows: auto 1fr auto; /* Header, Main (1fr), Footer */
            height: 100vh;
        }
        .header, .footer {
            flex-shrink: 0;
            background-color: #1a202c; /* Dark background for header/footer */
            color: #ffffff; /* White text for header/footer */
            padding: 1rem 2.5rem;
            font-size: 1.75rem; /* Increased font size */
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .footer {
            display: flex;
            align-items: center;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        .school-name {
            font-size: 2.75rem;
            font-weight: 800;
        }
        .clock {
            font-size: 2.75rem;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
        }
        .meal-title {
            font-weight: 700;
            margin-right: 1.5rem;
        }
        .content-slider {
            position: relative; /* Crucial for layout fix and progress bar */
            overflow: hidden; /* Hide anything that might spill out */
        }
        .swiper {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .swiper-slide {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            box-sizing: border-box;
        }
        .slide-content {
            width: 100%;
            height: 100%;
            padding: 2rem;
            overflow-y: auto;
            background-color: white; /* Changed to white */
            color: black; /* Changed to black for readability */
            border-radius: 0.5rem; /* Optional: Add some rounded corners */
            &::-webkit-scrollbar { width: 6px; }
            &::-webkit-scrollbar-track { background: transparent; }
            &::-webkit-scrollbar-thumb { background: rgba(0, 0, 0, 0.3); border-radius: 3px; } /* Adjusted scrollbar for dark on light */
        }
        .slider-progress-bar-container {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background-color: rgba(255, 255, 255, 0.2);
        }
        .slider-progress-bar {
            width: 0%;
            height: 100%;
            background-color: #34d399; /* Emerald-400 */
        }
        @keyframes progress-bar-kf {
            from { width: 0%; }
            to { width: 100%; }
        }
    </style>
</head>
<body>

    <div class="display-grid">
        <!-- Header: School Name and Clock -->
        <header class="header">
            <div class="flex items-center">
                <div id="school-name" class="school-name">ë¡œë”© ì¤‘...</div>
                <div class="ml-6 flex items-center space-x-2">
                    <button id="change-username-btn" class="px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>                   
                        ì‚¬ìš©ì ë³€ê²½     
                    </button>
                    <button id="fullscreen-btn" class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm font-medium flex items-center">
                        <svg class="w-4 h-4 mr-2 " fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/>
                        </svg>
                        ì „ì²´í™”ë©´
                    </button>
                </div>
            </div>
            <div id="clock" class="clock">00:00:00</div>
        </header>

        <!-- Main Content: Slider -->
        <main class="content-slider">
            <div class="swiper">
                <div class="swiper-wrapper">
                    <!-- Slides will be dynamically injected here -->
                </div>
            </div>
            <div class="slider-progress-bar-container">
                <div class="slider-progress-bar"></div>
            </div>
        </main>

        <!-- Footer: Meal Info -->
        <footer class="footer">
            <div class="meal-title">ì˜¤ëŠ˜ì˜ ê¸‰ì‹</div>
            <div id="meal-menu" class="flex-1">ë¡œë”© ì¤‘...</div>
        </footer>
    </div>

    <!-- Username Input Modal -->
    <div id="username-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4 text-center">
            <div class="mb-6">
                <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">ì‚¬ìš©ì ì •ë³´ ì…ë ¥</h2>
                <p class="text-gray-600">ë””ìŠ¤í”Œë ˆì´ë¥¼ ì‹œì‘í•˜ë ¤ë©´ ì‚¬ìš©ìëª…ì„ ì…ë ¥í•˜ì„¸ìš”</p>
            </div>
            
            <form id="username-form" class="space-y-4">
                <div>
                    <label for="username-input" class="block text-sm font-medium text-gray-700 mb-2 text-left">ì‚¬ìš©ìëª…</label>
                    <input type="text" id="username-input" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none transition-colors" placeholder="ì‚¬ìš©ìëª…ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                </div>
                <button type="submit" class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white font-bold py-3 px-6 rounded-lg hover:from-blue-600 hover:to-purple-700 transition-all transform hover:scale-105">
                    <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/>
                    </svg>
                    ë””ìŠ¤í”Œë ˆì´ ì‹œì‘
                </button>
                <a href="admin.php" class="w-full block bg-gray-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-700 transition-all transform hover:scale-105 text-center">
                    <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    ê´€ë¦¬í˜ì´ì§€ ë°”ë¡œê°€ê¸°
                </a>
            </form>
            
            <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                <p class="text-xs text-blue-700">
                    ğŸ’¡ <strong>ì•ˆë‚´:</strong> ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ ë“±ë¡í•œ ì‚¬ìš©ìëª…ì„ ì…ë ¥í•˜ì„¸ìš”
                </p>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const swiperWrapper = document.querySelector('.swiper-wrapper');
            const schoolNameEl = document.getElementById('school-name');
            const mealMenuEl = document.getElementById('meal-menu');
            const progressBar = document.querySelector('.slider-progress-bar');
            const usernameModal = document.getElementById('username-modal');
            const usernameForm = document.getElementById('username-form');
            const usernameInput = document.getElementById('username-input');
            let swiper;
            let lastSlidesHtml = '';
            let currentUsername = null;

            // URLì—ì„œ username íŒŒë¼ë¯¸í„° í™•ì¸
            const urlParams = new URLSearchParams(window.location.search);
            currentUsername = urlParams.get('username');

            // --- Username Modal Functions ---
            const showUsernameModal = () => {
                usernameModal.classList.remove('hidden');
                usernameInput.focus();
            };

            const hideUsernameModal = () => {
                usernameModal.classList.add('hidden');
            };

            const setUsername = (username) => {
                currentUsername = username;
                // URL ì—…ë°ì´íŠ¸ (ìƒˆë¡œê³ ì¹¨ ì—†ì´)
                const newUrl = new URL(window.location);
                newUrl.searchParams.set('username', username);
                window.history.replaceState({}, '', newUrl);
                hideUsernameModal();
                // ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
                fetchDisplayData(true);
            };

            // Username í¼ ì œì¶œ ì²˜ë¦¬
            usernameForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const username = usernameInput.value.trim();
                if (username) {
                    setUsername(username);
                }
            });

            // ì‚¬ìš©ì ë³€ê²½ ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬
            document.getElementById('change-username-btn').addEventListener('click', () => {
                usernameInput.value = currentUsername || '';
                showUsernameModal();
            });

            // --- Fullscreen Functions ---
            const fullscreenBtn = document.getElementById('fullscreen-btn');
            const changeUsernameBtn = document.getElementById('change-username-btn');
            
            const updateFullscreenBtn = () => {
                if (document.fullscreenElement) {
                    fullscreenBtn.style.display = 'none'; // ì „ì²´í™”ë©´ì¼ ë•Œ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
                    changeUsernameBtn.style.display = 'none'; // ì „ì²´í™”ë©´ì¼ ë•Œ ì‚¬ìš©ì ë³€ê²½ ë²„íŠ¼ë„ ìˆ¨ê¸°ê¸°
                } else {
                    fullscreenBtn.style.display = 'flex'; // ì „ì²´í™”ë©´ì´ ì•„ë‹ ë•Œ ë²„íŠ¼ ë³´ì´ê¸°
                    changeUsernameBtn.style.display = 'flex'; // ì „ì²´í™”ë©´ì´ ì•„ë‹ ë•Œ ì‚¬ìš©ì ë³€ê²½ ë²„íŠ¼ë„ ë³´ì´ê¸°
                }
            };

            const toggleFullscreen = () => {
                if (!document.fullscreenElement) {
                    // ì „ì²´í™”ë©´ ì§„ì…
                    document.documentElement.requestFullscreen().catch(err => {
                        console.log(`ì „ì²´í™”ë©´ ì§„ì… ì‹¤íŒ¨: ${err.message}`);
                    });
                } else {
                    // ì „ì²´í™”ë©´ í•´ì œ
                    document.exitFullscreen().catch(err => {
                        console.log(`ì „ì²´í™”ë©´ í•´ì œ ì‹¤íŒ¨: ${err.message}`);
                    });
                }
            };

            // ì „ì²´í™”ë©´ ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬
            fullscreenBtn.addEventListener('click', toggleFullscreen);

            // ì „ì²´í™”ë©´ ìƒíƒœ ë³€ê²½ ê°ì§€
            document.addEventListener('fullscreenchange', updateFullscreenBtn);

            // ESC í‚¤ë¡œ ì „ì²´í™”ë©´ í•´ì œ ê°ì§€
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && document.fullscreenElement) {
                    updateFullscreenBtn();
                }
            });

            // ì´ˆê¸° ì „ì²´í™”ë©´ ë²„íŠ¼ ìƒíƒœ ì„¤ì •
            updateFullscreenBtn();

            // --- Swiper & Progress Bar ---
            const startProgressBarAnimation = (duration) => {
                progressBar.style.animation = 'none';
                void progressBar.offsetWidth; // Trigger reflow to restart animation
                progressBar.style.animation = `progress-bar-kf ${duration}s linear forwards`;
            };

            const initializeSwiper = (slides) => {
                if (swiper) swiper.destroy(true, true);
                
                swiper = new Swiper('.swiper', {
                    loop: slides.length > 1, // Only loop if there is more than one slide
                    effect: 'fade',
                    fadeEffect: { crossFade: true },
                    autoplay: {
                        delay: (slides[0]?.duration || 10) * 1000,
                        disableOnInteraction: false,
                    },
                    on: {
                        init: (s) => {
                            const firstSlideDuration = s.slides[s.activeIndex]?.dataset.duration || 10;
                            startProgressBarAnimation(firstSlideDuration);
                        },
                        slideChangeTransitionStart: (s) => {
                            const currentSlide = s.slides[s.activeIndex];
                            if (!currentSlide) return;
                            
                            const duration = parseInt(currentSlide.dataset.duration, 10);
                            if (s.params.autoplay.delay !== duration * 1000) {
                                s.autoplay.stop();
                                s.params.autoplay.delay = duration * 1000;
                                s.autoplay.start();
                            }
                            startProgressBarAnimation(duration);
                        }
                    }
                });
            };

            // --- Data Rendering ---
            const renderSlides = (slides) => {
                swiperWrapper.innerHTML = '';
                if (slides.length === 0) {
                    swiperWrapper.innerHTML = `
                        <div class="swiper-slide" data-duration="10">
                            <div class="slide-content text-center">
                                <h2 class="text-5xl font-bold">ê³µì§€ì‚¬í•­</h2>
                                <p class="text-3xl mt-6">í˜„ì¬ ë“±ë¡ëœ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                            </div>
                        </div>`;
                } else {
                    slides.forEach(slide => {
                        const slideEl = document.createElement('div');
                        slideEl.className = 'swiper-slide';
                        slideEl.dataset.duration = slide.duration;
                        
                        // ìŠ¬ë¼ì´ë“œ ì½˜í…ì¸  ìƒì„± ë° iframe ë³´ì•ˆ ì²˜ë¦¬
                        const slideContent = document.createElement('div');
                        slideContent.className = 'slide-content';
                        slideContent.innerHTML = slide.content;
                        
                        // iframe íƒœê·¸ì— sandbox ì†ì„± ì¶”ê°€ (ë³´ì•ˆ ê°•í™”)
                        const iframes = slideContent.querySelectorAll('iframe');
                        iframes.forEach(iframe => {
                            // ê¸°ì¡´ sandbox ì†ì„±ì´ ì—†ëŠ” ê²½ìš°ì—ë§Œ ì¶”ê°€
                            // if (!iframe.hasAttribute('sandbox')) {
                                iframe.setAttribute('sandbox', 'allow-scripts allow-same-origin allow-popups allow-forms');
                            // }
                            // ì¶”ê°€ ë³´ì•ˆ ì†ì„±
                            iframe.setAttribute('referrerpolicy', 'no-referrer');
                            iframe.setAttribute('loading', 'lazy');
                        });
                        
                        slideEl.appendChild(slideContent);
                        swiperWrapper.appendChild(slideEl);
                    });
                }
                initializeSwiper(slides);
            };

            // --- Data Fetching ---
            const fetchMealInfo = async (areaCode, schoolCode) => {
                try {
                    const response = await fetch(`php/get_meal.php?area_code=${areaCode}&school_code=${schoolCode}`);
                    const result = await response.json();
                    mealMenuEl.textContent = result.status === 'success' ? result.menu : result.message;
                    console.log(result.date);
                } catch (error) {
                    console.error('Error fetching meal info:', error);
                    mealMenuEl.textContent = 'ê¸‰ì‹ ì •ë³´ ë¡œë”© ì‹¤íŒ¨';
                }
            };

            const fetchDisplayData = async (isInitialLoad = false) => {
                console.log(`[${new Date().toLocaleTimeString()}] ìµœì‹  ì½˜í…ì¸  í™•ì¸...`);
                try {
                    if (!currentUsername) {
                        schoolNameEl.textContent = "ì‚¬ìš©ì ì •ë³´ í•„ìš”";
                        renderSlides([{ content: '<div class="text-center text-3xl">ì‚¬ìš©ìëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.<br><br><div class="text-xl text-gray-600">ìš°ì¸¡ ìƒë‹¨ì˜ ì‚¬ìš©ì ì…ë ¥ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</div></div>', duration: 10 }]);
                        showUsernameModal();
                        return;
                    }

                    const response = await fetch(`php/get_display_data.php?username=${currentUsername}`);
                    const result = await response.json();

                    if (result.status === 'success') {
                        if (isInitialLoad) {
                            schoolNameEl.textContent = result.user_info.school_name;
                            // hide_meal_info ì„¤ì • í™•ì¸í•˜ì—¬ ê¸‰ì‹ ì •ë³´ í‘œì‹œ ì—¬ë¶€ ê²°ì •
                            const mealTitleEl = document.querySelector('.meal-title');
                            if (result.user_info.hide_meal_info == 1) {
                                mealTitleEl.textContent = '';
                                mealMenuEl.textContent = '';
                            } else {
                                mealTitleEl.textContent = 'ì˜¤ëŠ˜ì˜ ê¸‰ì‹';
                                // API ì •ë³´ê°€ ìˆì„ ë•Œë§Œ ê¸‰ì‹ ì •ë³´ ìš”ì²­
                                if (result.user_info.api_area_code && result.user_info.api_school_code) {
                                    fetchMealInfo(result.user_info.api_area_code, result.user_info.api_school_code);
                                } else {
                                    mealMenuEl.textContent = 'ê¸‰ì‹ ì •ë³´ ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤';
                                }
                            }
                        }

                        const newSlidesHtml = result.slides.map(s => s.content).join('');
                        if (lastSlidesHtml !== newSlidesHtml) {
                            console.log('ìƒˆë¡œìš´ ì½˜í…ì¸  ë°œê²¬! ìŠ¬ë¼ì´ë“œë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.');
                            lastSlidesHtml = newSlidesHtml;
                            renderSlides(result.slides);
                        }
                    } else {
                        schoolNameEl.textContent = "ì˜¤ë¥˜";
                        renderSlides([{ content: `<div class="text-center text-3xl">${result.message}<br><br><div class="text-xl text-gray-600">ë‹¤ë¥¸ ì‚¬ìš©ìëª…ì„ ì‹œë„í•´ë³´ì„¸ìš”</div></div>`, duration: 10 }]);
                        showUsernameModal();
                    }
                } catch (error) {
                    console.error('Error fetching display data:', error);
                    schoolNameEl.textContent = "ì—°ê²° ì˜¤ë¥˜";
                    renderSlides([{ content: '<div class="text-center text-3xl">ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.<br><br><div class="text-xl text-gray-600">ë„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”</div></div>', duration: 10 }]);
                }
            };
            
            // --- Clock ---
            let lastDate = new Date().toDateString(); // Store the last known date
            
            const updateClock = () => {
                const now = new Date();
                const currentDate = now.toDateString();
                
                // Check if date has changed (midnight passed)
                if (lastDate !== currentDate) {
                    console.log('ë‚ ì§œê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.');
                    location.reload(); // Refresh the entire page
                    return;
                }
                
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const dayOfWeek = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '][now.getDay()];
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const seconds = String(now.getSeconds()).padStart(2, '0');

                const formattedDate = `${year}.${month}.${day}(${dayOfWeek})`;
                const formattedTime = `${hours}:${minutes}:${seconds}`;

                document.getElementById('clock').textContent = `${formattedDate} ${formattedTime}`;
            };

            // --- Initial Load and Polling ---
            updateClock();
            setInterval(updateClock, 1000);
            
            fetchDisplayData(true); // Initial fetch
            setInterval(() => fetchDisplayData(false), 5000); // Poll for new data
        });
    </script>
   
</body>
</html>
